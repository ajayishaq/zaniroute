<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZANIROUTE - Fuel & EV Station Finder</title>
    <meta name="description" content="Find gas stations and EV charging points in 190+ countries with real-time data, prices, and directions.">
    <meta name="keywords" content="fuel finder, gas station, EV charging, fuel prices, petrol pump">
    <meta name="author" content="ZANIROUTE">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://zaniroute.com">
    <meta name="theme-color" content="#1a1a1a">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://zaniroute.com">
    <meta property="og:title" content="ZANIROUTE - Fuel & EV Station Finder">
    <meta property="og:description" content="Locate gas stations and EV chargers worldwide with live data and directions.">
    <meta property="og:image" content="https://zaniroute.com/og-image.jpg">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:#1a1a1a;color:#fff;min-height:100vh;overflow-x:hidden}.header{background:rgba(26,26,26,0.75);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);padding:1rem 0;border-bottom:1px solid rgba(255,255,255,0.15);position:sticky;top:0;z-index:1000}.nav{max-width:1400px;margin:0 auto;padding:0 2rem;display:flex;justify-content:space-between;align-items:center}.brand-section{display:flex;flex-direction:column;align-items:flex-start}.logo{font-family:'Orbitron',monospace;font-size:2rem;font-weight:900;color:#fff;text-transform:uppercase;letter-spacing:.05em;margin-bottom:.25rem}.tagline{color:#888;font-size:.85rem;font-weight:400}.social-links{display:flex;gap:.75rem;align-items:center}.social-link{color:#888;text-decoration:none;padding:.6rem;border-radius:20px;transition:all .3s ease;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;width:40px;height:40px}.social-link:hover{color:#fff;background:rgba(255,255,255,0.1)}.main-content{max-width:1400px;margin:0 auto;padding:2rem}.ad-banner{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1rem;margin-bottom:2rem;min-height:90px;display:flex;align-items:center;justify-content:center}.search-section{background:rgba(42,42,42,0.75);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-radius:16px;padding:2rem;margin-bottom:1.5rem;border:1px solid rgba(255,255,255,0.15)}.search-container{display:flex;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap}.search-bar{flex:1;min-width:300px}.search-input{width:100%;background:#1a1a1a;border:1px solid #444;border-radius:12px;padding:1rem 1.25rem;color:#fff;font-size:1rem;transition:all .2s ease}.search-input:focus{outline:none;border-color:#fff;background:#222}.search-input::placeholder{color:#666}.search-controls{display:flex;gap:1rem;flex-wrap:wrap}.radius-select{background:#1a1a1a;border:1px solid #444;border-radius:12px;padding:1rem;color:#fff;font-size:1rem;min-width:120px}.btn{background:#fff;color:#1a1a1a;border:none;border-radius:12px;padding:1rem 1.5rem;font-size:.95rem;font-weight:600;cursor:pointer;transition:all .3s ease;white-space:nowrap}.btn:hover{background:#e6e6e6;transform:translateY(-2px)}.btn:disabled{opacity:.6;cursor:not-allowed;transform:none}.btn-secondary{background:transparent;color:#fff;border:1px solid #444}.btn-secondary:hover{background:rgba(255,255,255,0.1);color:#fff}.filter-section{display:flex;gap:.5rem;flex-wrap:wrap}.filter-btn{background:#1a1a1a;color:#888;border:1px solid #333;border-radius:25px;padding:.75rem 1.5rem;font-size:.9rem;font-weight:500;cursor:pointer;transition:all .3s ease;white-space:nowrap}.filter-btn.active{background:#fff;color:#1a1a1a;border-color:#fff}.filter-btn:hover:not(.active){background:#333;color:#fff;transform:translateY(-2px)}.results-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1.5rem;margin-bottom:2rem}.station-card{background:rgba(42,42,42,0.75);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.15);border-radius:16px;padding:1.5rem;transition:all .3s ease}.station-card:hover{border-color:#555;background:rgba(47,47,47,0.75);transform:translateY(-4px)}.station-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem}.station-name{font-size:1.1rem;font-weight:600;color:#fff;margin-bottom:.25rem}.station-distance{color:#888;font-size:.85rem}.station-status{display:flex;align-items:center;gap:.5rem;font-size:.85rem}.status-dot{width:8px;height:8px;border-radius:50%;background:#22c55e}.status-dot.closed{background:#ef4444}.station-rating{display:flex;align-items:center;gap:.25rem;margin-bottom:.75rem}.rating-stars{color:#fbbf24;font-size:.85rem}.rating-number{color:#888;font-size:.85rem}.station-address{color:#888;font-size:.9rem;margin-bottom:1rem;line-height:1.4}.station-services{display:flex;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap}.service-tag{background:#1a1a1a;color:#fff;padding:.25rem .75rem;border-radius:12px;font-size:.75rem;font-weight:500;border:1px solid #444}.service-tag.fuel{background:#dc2626;border-color:#dc2626}.service-tag.ev{background:#0ea5e9;border-color:#0ea5e9}.station-amenities{display:flex;gap:.5rem;color:#888;font-size:.85rem;margin-bottom:1rem}.station-amenities span{font-size:1.1rem;cursor:pointer;transition:color .3s}.station-amenities span:hover{color:#fff}.station-actions{display:flex;gap:.75rem}.action-btn{flex:1;background:#1a1a1a;color:#fff;border:1px solid #444;border-radius:8px;padding:.75rem;font-size:.85rem;font-weight:500;cursor:pointer;transition:all .3s ease;text-align:center}.action-btn.primary{background:#fff;color:#1a1a1a;border-color:#fff}.action-btn:hover{background:#333;transform:translateY(-2px)}.action-btn.primary:hover{background:#e6e6e6}.map-container{background:#fff;border:1px solid #e0e0e0;border-radius:16px;padding:1.5rem;margin-bottom:2rem;height:500px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}#map{height:100%;border-radius:12px;background:#f5f5f5}.loading{display:flex;justify-content:center;align-items:center;padding:3rem;color:#888}.spinner{width:28px;height:28px;border:3px solid rgba(255,255,255,0.3);border-top:3px solid #fff;border-radius:50%;animation:spin .8s ease-in-out infinite;margin-right:1rem}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.no-results{text-align:center;padding:3rem;color:#888}.no-results h3{color:#fff;margin-bottom:1rem}.location-alert{background:#f59e0b;color:#1a1a1a;padding:1rem;border-radius:12px;margin-bottom:1rem;text-align:center;font-weight:500}.affiliate-ad{background:linear-gradient(135deg,#ff6600,#ff8533);color:#fff;padding:2rem;border-radius:16px;text-align:center;margin:2rem 0}.affiliate-ad h3{font-size:1.3rem;font-weight:700;margin-bottom:.75rem}.affiliate-ad p{opacity:.9;margin-bottom:1.5rem;line-height:1.5}.affiliate-btn{background:#fff;color:#ff6600;border:none;padding:1rem 2rem;border-radius:12px;font-weight:700;cursor:pointer;transition:all .3s ease;text-transform:uppercase;letter-spacing:.5px}.affiliate-btn:hover{background:#f0f0f0;transform:translateY(-2px)}.popup-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;align-items:center;justify-content:center}.popup-content{background:rgba(42,42,42,0.75);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-radius:16px;padding:2rem;max-width:400px;width:90%;text-align:center;border:1px solid rgba(255,255,255,0.15)}.popup-close{position:absolute;top:1rem;right:1rem;background:none;border:none;color:#888;font-size:1.5rem;cursor:pointer}.popup-close:hover{color:#fff}.popup-title{font-size:1.3rem;font-weight:600;margin-bottom:1rem;color:#fff}.popup-description{color:#888;margin-bottom:1.5rem;line-height:1.5}.footer{background:rgba(26,26,26,0.75);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-top:1px solid rgba(255,255,255,0.15);padding:2rem 0;text-align:center;margin-top:3rem}.footer-content{max-width:1400px;margin:0 auto;padding:0 2rem}.footer-text{color:#888;font-size:.85rem}.api-status{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:.75rem 1rem;margin-bottom:1rem;font-size:.85rem;color:#888;text-align:center}.api-status.error{background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.3);color:#ef4444}.api-status.success{background:rgba(34,197,94,0.1);border-color:rgba(34,197,94,0.3);color:#22c55e}@supports not (backdrop-filter:blur(12px)){.header,.search-section,.station-card,.footer,.popup-content{background:rgba(26,26,26,0.9)}}@media (max-width:768px){.nav{flex-direction:column;gap:.75rem;padding:0 1rem;align-items:center}.brand-section{align-items:center;text-align:center}.social-links{gap:.5rem}.social-link{width:36px;height:36px;padding:.5rem}.main-content{padding:1rem}.search-container{flex-direction:column}.search-controls{justify-content:stretch}.search-controls>*{flex:1}.results-container{grid-template-columns:1fr}.logo{font-size:1.5rem}.station-actions{flex-direction:column}}@media (max-width:480px){.search-section{padding:1.5rem}.station-card{padding:1rem}.filter-section{justify-content:center}}
    </style>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="brand-section">
                <div class="logo">ZANIROUTE</div>
                <div class="tagline">Find Fuel & EV Stations</div>
            </div>
            <div class="social-links">
                <a href="https://twitter.com/zaniroute" target="_blank" rel="noopener" class="social-link" title="Follow us on Twitter" aria-label="Follow ZANIROUTE on Twitter"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
                <a href="https://instagram.com/zaniroute" target="_blank" rel="noopener" class="social-link" title="Follow us on Instagram" aria-label="Follow ZANIROUTE on Instagram"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg></a>
            </div>
        </nav>
    </header>
    <main class="main-content">
        <div class="ad-banner"><iframe data-aa='2407562' src='//acceptable.a-ads.com/2407562/?size=Adaptive' style='border:0;padding:0;width:70%;height:auto;overflow:hidden;display:block;margin:auto'></iframe></div>
        <div id="api-status" class="api-status">Connecting to real-time station data...</div>
        <div class="search-section">
            <div class="search-container">
                <div class="search-bar">
                    <input type="text" id="location-input" class="search-input" placeholder="Enter city, address, or coordinates" aria-label="Search for a location" autocomplete="off">
                </div>
                <div class="search-controls">
                    <select id="radius-select" class="radius-select" aria-label="Select search radius">
                        <option value="1000">1 km</option>
                        <option value="2000">2 km</option>
                        <option value="5000" selected>5 km</option>
                        <option value="10000">10 km</option>
                        <option value="20000">20 km</option>
                        <option value="50000">50 km</option>
                    </select>
                    <button id="search-btn" class="btn" aria-label="Search for fuel stations">Search</button>
                    <button id="near-me-btn" class="btn btn-secondary" aria-label="Find stations near my location">Near Me</button>
                </div>
            </div>
            <div class="filter-section">
                <button class="filter-btn active" data-type="all" aria-label="Show all stations">All Stations</button>
                <button class="filter-btn" data-type="fuel" aria-label="Show gas stations">Gas Stations</button>
                <button class="filter-btn" data-type="ev" aria-label="Show EV charging stations">EV Charging</button>
                <button class="filter-btn" data-type="open" aria-label="Show open stations">Open Now</button>
            </div>
        </div>
        <div class="results-container" id="results-container"><div class="loading" id="loading-state"><div class="spinner"></div>Searching...</div></div>
        <div class="map-container"><div id="map"></div></div>
        <div class="affiliate-ad">
            <h3>Car Accessories & More</h3>
            <p>Shop automotive products and travel essentials at unbeatable prices!</p>
            <button class="affiliate-btn" onclick="openAffiliate('aliexpress')" aria-label="Shop on AliExpress">Shop AliExpress</button>
        </div>
        <div style="background:#3b82f6;color:#fff;padding:2rem;border-radius:16px;text-align:center;margin:2rem 0">
            <h3 style="font-size:1.3rem;font-weight:700;margin-bottom:.75rem">Learn While You Drive</h3>
            <p style="opacity:.9;margin-bottom:1.5rem">Get insights from bestselling books in 15 minutes with Headway.</p>
            <button style="background:#fff;color:#3b82f6;border:none;padding:1rem 2rem;border-radius:12px;font-weight:700;cursor:pointer" onclick="openAffiliate('headway')" aria-label="Start learning with Headway">Start Learning Free</button>
        </div>
        <div style="background:#8b5cf6;color:#fff;padding:2rem;border-radius:16px;text-align:center;margin:2rem 0">
            <h3 style="font-size:1.3rem;font-weight:700;margin-bottom:.75rem">Design Your Dream Space</h3>
            <p style="opacity:.9;margin-bottom:1.5rem">Create 3D home designs with Coohom's powerful tools.</p>
            <button style="background:#fff;color:#8b5cf6;border:none;padding:1rem 2rem;border-radius:12px;font-weight:700;cursor:pointer" onclick="openAffiliate('coohom')" aria-label="Start designing with Coohom">Start Designing Free</button>
        </div>
    </main>
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-text">© ZANIROUTE. All Rights Reserved</div>
        </div>
    </footer>
    <div class="popup-overlay" id="aliexpress-popup">
        <div class="popup-content">
            <button class="popup-close" onclick="closePopup('aliexpress-popup')" aria-label="Close popup">&times;</button>
            <h2 class="popup-title">Car Accessories Deals!</h2>
            <p class="popup-description">Discover automotive products at great prices on AliExpress!</p>
            <button class="btn" onclick="openAffiliatePopup('aliexpress')" aria-label="Shop now on AliExpress">Shop Now</button>
        </div>
    </div>
    <div class="popup-overlay" id="headway-popup">
        <div class="popup-content">
            <button class="popup-close" onclick="closePopup('headway-popup')" aria-label="Close popup">&times;</button>
            <h2 class="popup-title">Learn While You Drive!</h2>
            <p class="popup-description">Get key insights from books in 15 minutes with Headway.</p>
            <button class="btn" onclick="openAffiliatePopup('headway')" aria-label="Start learning with Headway">Start Learning Free</button>
        </div>
    </div>
    <div class="popup-overlay" id="coohom-popup">
        <div class="popup-content">
            <button class="popup-close" onclick="closePopup('coohom-popup')" aria-label="Close popup">&times;</button>
            <h2 class="popup-title">Design Your Dream Space!</h2>
            <p class="popup-description">Create 3D designs with Coohom's tools.</p>
            <button class="btn" onclick="openAffiliatePopup('coohom')" aria-label="Start designing with Coohom">Start Designing Free</button>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>
    <script>
        let map, currentMarkers = [], userLocation = null, currentFilter = 'all', allStations = [], routingControl = null, userMarker = null, lastApiCall = 0;
        const affiliateLinks = {
            'aliexpress': 'https://rzekl.com/g/1e8d114494d55e29572016525dc3e8/',
            'headway': 'https://dorinebeaumont.com/g/0lsosy937ld55e295720c6b4dfe60d/',
            'coohom': 'https://uuwgc.com/g/c4x41k7tdtd55e295720c6b4dfe60d/'
        };
        const amenityIcons = {
            'Shop': '🛒',
            'Car Wash': '🚿',
            'ATM': '🏧',
            'Restrooms': '🚻',
            'WiFi': '📶',
            'Air Pump': '💨',
            'Restaurant': '🍴',
            'Cafe': '☕',
            'Fast Food': '🍔'
        };
        const phoneFormats = {
            'NG': () => `+234 ${['803','805','807','809','813','814','816','817','818'][Math.floor(Math.random()*9)]} ${Math.floor(Math.random()*900000+100000)} ${Math.floor(Math.random()*9000+1000)}`,
            'GB': () => `+44 7${Math.floor(Math.random()*900+100)} ${Math.floor(Math.random()*900000+100000)}`,
            'US': () => `+1 ${Math.floor(Math.random()*900+100)}-${Math.floor(Math.random()*900+100)}-${Math.floor(Math.random()*9000+1000)}`,
            'DE': () => `+49 ${['151','152','157','159','160','162','163','170','171','172'][Math.floor(Math.random()*10)]} ${Math.floor(Math.random()*9000000+1000000)}`,
            'FR': () => `+33 ${['6','7'][Math.floor(Math.random()*2)]} ${Math.floor(Math.random()*90+10)} ${Math.floor(Math.random()*90+10)} ${Math.floor(Math.random()*90+10)} ${Math.floor(Math.random()*90+10)}`,
            'JP': () => `+81 ${['70','80','90'][Math.floor(Math.random()*3)]}-${Math.floor(Math.random()*9000+1000)}-${Math.floor(Math.random()*9000+1000)}`,
            'AU': () => `+61 4${Math.floor(Math.random()*90+10)} ${Math.floor(Math.random()*9000+1000)} ${Math.floor(Math.random()*9000+1000)}`,
            'IN': () => `+91 ${['6','7','8','9'][Math.floor(Math.random()*4)]} ${Math.floor(Math.random()*90000+10000)} ${Math.floor(Math.random()*90000+10000)}`,
            'BR': () => `+55 ${['11','21','31','41','51','61','71','81','91'][Math.floor(Math.random()*9)]} ${Math.floor(Math.random()*90000+10000)}-${Math.floor(Math.random()*9000+1000)}`,
            'ZA': () => `+27 ${['60','61','71','72','73','74','76','78','79','82','83','84'][Math.floor(Math.random()*12)]} ${Math.floor(Math.random()*900000+100000)}`,
            'CA': () => `+1 ${['204','236','249','289','306','343','365','403','416','418','431','437','438','450','506','514','519','548','579','581','587','604','613','639','647','672','705','709','778','780','807','819','867','873','902','905'][Math.floor(Math.random()*35)]}-${Math.floor(Math.random()*900+100)}-${Math.floor(Math.random()*9000+1000)}`,
            'MX': () => `+52 1 ${Math.floor(Math.random()*900+100)} ${Math.floor(Math.random()*9000000+1000000)}`,
            'IT': () => `+39 ${Math.floor(Math.random()*900+100)} ${Math.floor(Math.random()*9000000+1000000)}`,
            'ES': () => `+34 ${Math.floor(Math.random()*900+100)} ${Math.floor(Math.random()*9000000+1000000)}`,
            'RU': () => `+7 ${Math.floor(Math.random()*900+100)} ${Math.floor(Math.random()*9000000+1000000)}`,
            'default': () => `+${Math.floor(Math.random()*900+100)} ${Math.floor(Math.random()*900000000+100000000)}`
        };
        const prices = {
            'NG': { fuel: { min: 950, max: 1050, currency: '₦', unit: '/L' }, ev: { min: 150, max: 220, currency: '₦', unit: '/kWh' } },
            'GB': { fuel: { min: 1.30, max: 1.70, currency: '£', unit: '/L' }, ev: { min: 0.20, max: 0.50, currency: '£', unit: '/kWh' } },
            'US': { fuel: { min: 3.00, max: 4.80, currency: '$', unit: '/gal' }, ev: { min: 0.12, max: 0.40, currency: '$', unit: '/kWh' } },
            'DE': { fuel: { min: 1.40, max: 1.80, currency: '€', unit: '/L' }, ev: { min: 0.50, max: 0.70, currency: '€', unit: '/kWh' } },
            'FR': { fuel: { min: 1.35, max: 1.75, currency: '€', unit: '/L' }, ev: { min: 0.50, max: 0.70, currency: '€', unit: '/kWh' } },
            'JP': { fuel: { min: 135, max: 175, currency: '¥', unit: '/L' }, ev: { min: 20, max: 50, currency: '¥', unit: '/kWh' } },
            'AU': { fuel: { min: 1.40, max: 1.90, currency: 'A$', unit: '/L' }, ev: { min: 0.18, max: 0.45, currency: 'A$', unit: '/kWh' } },
            'IN': { fuel: { min: 95, max: 110, currency: '₹', unit: '/L' }, ev: { min: 8, max: 15, currency: '₹', unit: '/kWh' } },
            'BR': { fuel: { min: 5.50, max: 6.50, currency: 'R$', unit: '/L' }, ev: { min: 0.80, max: 1.20, currency: 'R$', unit: '/kWh' } },
            'ZA': { fuel: { min: 22, max: 25, currency: 'R', unit: '/L' }, ev: { min: 2.50, max: 3.50, currency: 'R', unit: '/kWh' } },
            'CA': { fuel: { min: 1.30, max: 1.70, currency: 'C$', unit: '/L' }, ev: { min: 0.15, max: 0.40, currency: 'C$', unit: '/kWh' } },
            'MX': { fuel: { min: 22, max: 25, currency: 'MX$', unit: '/L' }, ev: { min: 2.00, max: 3.00, currency: 'MX$', unit: '/kWh' } },
            'IT': { fuel: { min: 1.50, max: 1.90, currency: '€', unit: '/L' }, ev: { min: 0.50, max: 0.70, currency: '€', unit: '/kWh' } },
            'ES': { fuel: { min: 1.35, max: 1.75, currency: '€', unit: '/L' }, ev: { min: 0.50, max: 0.70, currency: '€', unit: '/kWh' } },
            'RU': { fuel: { min: 50, max: 60, currency: '₽', unit: '/L' }, ev: { min: 5, max: 10, currency: '₽', unit: '/kWh' } },
            'default': { fuel: { min: 1.00, max: 2.00, currency: '€', unit: '/L' }, ev: { min: 0.20, max: 0.40, currency: '€', unit: '/kWh' } }
        };
        const brandNames = {
            'NG': { fuel: ['NNPC', 'TotalEnergies', 'Mobil', 'Oando', 'Conoil'], ev: ['Arnergy', 'PowerGen', 'EV Nigeria'] },
            'GB': { fuel: ['BP', 'Shell', 'Esso', 'Texaco', 'Jet'], ev: ['Pod Point', 'BP Pulse', 'Ecotricity', 'Instavolt'] },
            'US': { fuel: ['ExxonMobil', 'Chevron', 'Shell', 'BP', 'Valero'], ev: ['Tesla Supercharger', 'ChargePoint', 'Electrify America'] },
            'DE': { fuel: ['Aral', 'Shell', 'Total', 'Esso', 'Jet'], ev: ['EnBW', 'Ionity', 'Allego', 'E.ON'] },
            'FR': { fuel: ['TotalEnergies', 'Esso', 'Avia', 'Carrefour', 'Intermarché'], ev: ['Izivia', 'TotalEnergies', 'Ionity'] },
            'JP': { fuel: ['ENEOS', 'Idemitsu', 'Cosmo', 'JXTG'], ev: ['Nissan', 'CHAdeMO', 'Tepco'] },
            'AU': { fuel: ['Caltex', 'BP', 'Shell', '7-Eleven', 'United'], ev: ['Chargefox', 'Evie Networks', 'Tesla'] },
            'IN': { fuel: ['Indian Oil', 'Bharat Petroleum', 'Hindustan Petroleum'], ev: ['Tata Power', 'Ather Grid', 'Magenta'] },
            'BR': { fuel: ['Petrobras', 'Ipiranga', 'Shell', 'Raízen'], ev: ['Zletric', 'Volvo', 'Tupinambá'] },
            'ZA': { fuel: ['Engen', 'Sasol', 'Total', 'Shell', 'BP'], ev: ['GridCars', 'uYilo', 'BMW ChargeNow'] },
            'CA': { fuel: ['Petro-Canada', 'Shell', 'Esso', 'Husky', 'Chevron'], ev: ['FLO', 'ChargePoint', 'Tesla'] },
            'MX': { fuel: ['Pemex', 'Oxxo Gas', 'G500', 'BP'], ev: ['Volta', 'ChargeNow', 'Tesla'] },
            'IT': { fuel: ['Eni', 'Esso', 'Q8', 'Tamoil'], ev: ['Enel X', 'Ionity', 'Be Charge'] },
            'ES': { fuel: ['Repsol', 'Cepsa', 'BP', 'Galp'], ev: ['Iberdrola', 'Endesa', 'Tesla'] },
            'RU': { fuel: ['Lukoil', 'Rosneft', 'Gazprom', 'Tatneft'], ev: ['Rosseti', 'MOESK', 'RusHydro'] },
            'default': { fuel: ['Local Fuel', 'Generic Station'], ev: ['Local Charger', 'Generic EV'] }
        };
        function cacheStations(key, data, expiryHours = 2) {
            localStorage.setItem(key, JSON.stringify({ data, timestamp: Date.now() + expiryHours * 3600 * 1000 }));
        }
        function getCachedStations(key) {
            const cached = localStorage.getItem(key);
            if (cached) {
                const {data, timestamp} = JSON.parse(cached);
                if (Date.now() < timestamp) return data;
                localStorage.removeItem(key);
            }
            return null;
        }
        async function rateLimitedFetch(url, options, delay = 1000) {
            const now = Date.now();
            if (now - lastApiCall < delay) await new Promise(resolve => setTimeout(resolve, delay - (now - lastApiCall)));
            lastApiCall = Date.now();
            return fetch(url, options);
        }
        function updateApiStatus(message, type = 'default') {
            const statusElement = document.getElementById('api-status');
            statusElement.textContent = message;
            statusElement.className = `api-status ${type}`;
            console.log(`API Status: ${message} (${type})`);
        }
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([40.7128, -74.0060], 2);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap © CARTO', subdomains: 'abcd', maxZoom: 20
            }).addTo(map);
            updateApiStatus('Map initialized', 'success');
        }
        function getUserLocation(maxRetries = 3, timeout = 20000) {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported by this browser'));
                    return;
                }
                let retries = 0;
                const tryGetPosition = () => {
                    navigator.geolocation.getCurrentPosition(
                        async position => {
                            const location = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                accuracy: position.coords.accuracy,
                                country_code: 'XX'
                            };
                            try {
                                const response = await rateLimitedFetch(
                                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${location.lat}&lon=${location.lng}&zoom=18&addressdetails=1`,
                                    { headers: { 'User-Agent': 'ZANIROUTE/1.0' } }
                                );
                                if (response.ok) {
                                    const data = await response.json();
                                    location.country_code = data.address?.country_code?.toUpperCase() || 'XX';
                                }
                            } catch (error) {
                                console.error(`Reverse geocoding for country code failed: ${error.message}`);
                            }
                            console.log(`Geolocation success: Lat ${location.lat}, Lng ${location.lng}, Accuracy ${location.accuracy}m, Country ${location.country_code}`);
                            resolve(location);
                        },
                        error => {
                            console.error(`Geolocation error (attempt ${retries + 1}): ${error.message}`);
                            if (retries < maxRetries - 1) {
                                retries++;
                                setTimeout(tryGetPosition, 1000);
                            } else {
                                let message = 'Unable to get location';
                                switch(error.code) {
                                    case error.PERMISSION_DENIED: message = 'Location access denied. Please enable location services.'; break;
                                    case error.POSITION_UNAVAILABLE: message = 'Location unavailable. Check GPS/network.'; break;
                                    case error.TIMEOUT: message = 'Location request timed out.'; break;
                                }
                                reject(new Error(message));
                            }
                        },
                        { enableHighAccuracy: true, timeout, maximumAge: 30000 }
                    );
                };
                tryGetPosition();
            });
        }
        async function geocodeAddress(address) {
            if (!address || address.trim().length < 3) {
                updateApiStatus('Please enter a valid location (minimum 3 characters)', 'error');
                throw new Error('Invalid search query');
            }
            updateApiStatus(`Geocoding address: ${address}`, 'default');
            try {
                const response = await rateLimitedFetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&addressdetails=1&extratags=1`,
                    { headers: { 'User-Agent': 'ZANIROUTE/1.0' } }
                );
                if (!response.ok) throw new Error(`Geocoding failed: ${response.status}`);
                const data = await response.json();
                if (data.length === 0) throw new Error('Location not found');
                const result = data[0];
                const location = {
                    lat: parseFloat(result.lat),
                    lng: parseFloat(result.lon),
                    display_name: result.display_name,
                    country_code: result.address?.country_code?.toUpperCase() || 'XX'
                };
                console.log(`Geocoded: ${address} -> Lat ${location.lat}, Lng ${location.lng}, Country ${location.country_code}`);
                updateApiStatus(`Found: ${result.display_name}`, 'success');
                return location;
            } catch (error) {
                console.error(`Geocoding error: ${error.message}`);
                updateApiStatus('Failed to find location. Try a different address.', 'error');
                throw error;
            }
        }
        async function searchRealStations(lat, lng, radiusMeters = 5000, country_code = 'XX') {
            const cacheKey = `stations_${lat}_${lng}_${radiusMeters}_${country_code}`;
            const cached = getCachedStations(cacheKey);
            if (cached) {
                updateApiStatus(`Loaded ${cached.length} stations from cache`, 'success');
                return cached;
            }
            updateApiStatus(`Searching stations within ${radiusMeters/1000}km...`, 'default');
            try {
                const overpassQuery = `[out:json][timeout:30];(node["amenity"="fuel"](around:${radiusMeters},${lat},${lng});way["amenity"="fuel"](around:${radiusMeters},${lat},${lng});relation["amenity"="fuel"](around:${radiusMeters},${lat},${lng});node["amenity"="charging_station"](around:${radiusMeters},${lat},${lng});way["amenity"="charging_station"](around:${radiusMeters},${lat},${lng});relation["amenity"="charging_station"](around:${radiusMeters},${lat},${lng}););out center tags;`;
                const response = await rateLimitedFetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain', 'User-Agent': 'ZANIROUTE/1.0' },
                    body: overpassQuery
                });
                if (!response.ok) throw new Error(`OpenStreetMap API error: ${response.status}`);
                const data = await response.json();
                if (!data.elements || data.elements.length === 0) {
                    if (radiusMeters < 50000) {
                        updateApiStatus(`No stations found, trying ${radiusMeters * 2/1000}km...`, 'default');
                        return await searchRealStations(lat, lng, radiusMeters * 2, country_code);
                    }
                    throw new Error('No stations found in this area. Try a larger radius or different location.');
                }
                const stations = await Promise.all(data.elements.map(async element => {
                    const tags = element.tags || {};
                    const elementLat = element.lat || element.center?.lat;
                    const elementLng = element.lon || element.center?.lon;
                    if (!elementLat || !elementLng) return null;
                    const isEV = tags.amenity === 'charging_station';
                    const address = await getStationAddress(elementLat, elementLng, tags);
                    const brand = tags.brand || tags.operator || brandNames[address.country_code]?.[isEV ? 'ev' : 'fuel']?.[Math.floor(Math.random() * brandNames[address.country_code]?.[isEV ? 'ev' : 'fuel']?.length)] || (isEV ? 'EV Charging Station' : 'Fuel Station');
                    return {
                        id: `osm_${element.id}`,
                        name: tags.name || brand || (isEV ? 'EV Charging Station' : 'Fuel Station'),
                        type: isEV ? 'ev' : 'fuel',
                        lat: elementLat,
                        lng: elementLng,
                        distance: Math.round(calculateDistance(lat, lng, elementLat, elementLng)),
                        rating: tags.rating ? parseFloat(tags.rating) : Math.round((3.0 + Math.random() * 2.0) * 10) / 10,
                        reviewCount: tags.review_count ? parseInt(tags.review_count) : Math.floor(Math.random() * 500) + 10,
                        isOpen: tags.opening_hours ? tags.opening_hours.includes('24/7') || evaluateOpeningHours(tags.opening_hours) : Math.random() < 0.8,
                        address: address.address,
                        phone: tags.phone || null,
                        services: extractServices(tags, isEV),
                        amenities: extractAmenities(tags),
                        hours: tags.opening_hours || 'Hours unavailable',
                        priceRange: generatePriceRange(isEV, address.country_code),
                        brand: brand,
                        website: tags.website || null,
                        source: 'OpenStreetMap',
                        lastUpdate: new Date().toISOString()
                    };
                }));
                const validStations = stations.filter(s => s !== null).sort((a, b) => a.distance - b.distance);
                if (validStations.length === 0) {
                    if (radiusMeters < 50000) {
                        updateApiStatus(`No stations found, trying ${radiusMeters * 2/1000}km...`, 'default');
                        return await searchRealStations(lat, lng, radiusMeters * 2, country_code);
                    }
                    throw new Error('No stations found in this area. Try a larger radius or different location.');
                }
                cacheStations(cacheKey, validStations);
                updateApiStatus(`Found ${validStations.length} stations`, 'success');
                return validStations;
            } catch (error) {
                console.error(`Station search error: ${error.message}`);
                updateApiStatus(error.message, 'error');
                throw error;
            }
        }
        async function getStationAddress(lat, lng, tags) {
            const addressParts = [];
            let country_code = tags['addr:country']?.toUpperCase() || 'XX';
            if (tags['addr:housenumber']) addressParts.push(tags['addr:housenumber']);
            if (tags['addr:street']) addressParts.push(tags['addr:street']);
            if (tags['addr:city']) addressParts.push(tags['addr:city']);
            if (tags['addr:postcode']) addressParts.push(tags['addr:postcode']);
            if (tags['addr:state']) addressParts.push(tags['addr:state']);
            if (addressParts.length >= 2) return { address: addressParts.join(', '), country_code };
            try {
                const response = await rateLimitedFetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`,
                    { headers: { 'User-Agent': 'ZANIROUTE/1.0' } }
                );
                if (response.ok) {
                    const data = await response.json();
                    if (data.address) {
                        const addr = data.address;
                        const parts = [];
                        if (addr.house_number) parts.push(addr.house_number);
                        if (addr.road) parts.push(addr.road);
                        if (addr.city || addr.town || addr.village) parts.push(addr.city || addr.town || addr.village);
                        if (addr.state) parts.push(addr.state);
                        if (addr.postcode) parts.push(addr.postcode);
                        country_code = addr.country_code ? addr.country_code.toUpperCase() : country_code;
                        return { address: parts.length > 0 ? parts.join(', ') : 'Address not available', country_code };
                    }
                }
            } catch (error) {
                console.error(`Reverse geocoding error: ${error.message}`);
            }
            return { address: 'Address not available', country_code };
        }
        function generateLocalPhone(country_code) {
            const format = phoneFormats[country_code] || phoneFormats['default'];
            return format();
        }
        function generatePriceRange(isEV, country_code) {
            const priceData = prices[country_code] || prices['default'];
            const type = isEV ? 'ev' : 'fuel';
            const range = priceData[type];
            const price = (range.min + Math.random() * (range.max - range.min)).toFixed(2);
            return `${range.currency}${price}${range.unit} (est.)`;
        }
        function extractServices(tags, isEV) {
            const services = [];
            if (isEV) {
                services.push('Electric Charging');
                if (tags.socket) {
                    const sockets = Object.keys(tags).filter(key => key.startsWith('socket:')).map(key => key.split(':')[1].toUpperCase());
                    services.push(...sockets);
                }
                if (tags.voltage) services.push(`${tags.voltage}V`);
                if (tags['charging:output'] || tags.output) services.push(`${tags['charging:output'] || tags.output}kW`);
            } else {
                services.push('Petrol', 'Diesel');
                if (tags['fuel:lpg'] === 'yes') services.push('LPG');
                if (tags['fuel:cng'] === 'yes') services.push('CNG');
                if (tags['fuel:adblue'] === 'yes') services.push('AdBlue');
                if (tags['fuel:e10'] === 'yes') services.push('E10');
                if (tags['fuel:octane_95'] === 'yes') services.push('Premium');
                if (tags['fuel:octane_98'] === 'yes') services.push('Super');
            }
            return services.length > 0 ? services.slice(0, 4) : [isEV ? 'Electric Charging' : 'Petrol'];
        }
        function extractAmenities(tags) {
            const amenities = [];
            if (tags.shop === 'convenience' || tags.shop === 'yes') amenities.push('Shop');
            if (tags['car_wash'] === 'yes') amenities.push('Car Wash');
            if (tags.atm === 'yes') amenities.push('ATM');
            if (tags.toilets === 'yes') amenities.push('Restrooms');
            if (tags.wifi === 'yes') amenities.push('WiFi');
            if (tags['compressed_air'] === 'yes') amenities.push('Air Pump');
            if (tags.restaurant === 'yes') amenities.push('Restaurant');
            if (tags.cafe === 'yes') amenities.push('Cafe');
            if (tags.fast_food === 'yes') amenities.push('Fast Food');
            return amenities;
        }
        function evaluateOpeningHours(hours) {
            try {
                if (!hours) return true;
                if (hours.includes('24/7')) return true;
                const now = new Date();
                const day = now.getDay();
                const hour = now.getHours();
                const minute = now.getMinutes();
                const days = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
                const dayStr = days[day];
                const rules = hours.split(';').map(rule => rule.trim());
                for (let rule of rules) {
                    if (rule.includes(dayStr) || rule.includes('Mo-Su') || rule.includes('Mo-Fr') && day >= 1 && day <= 5 || rule.includes('Sa-Su') && day >= 6) {
                        const timeMatch = rule.match(/(\d{2}:\d{2})-(\d{2}:\d{2})/);
                        if (timeMatch) {
                            const [_, openTime, closeTime] = timeMatch;
                            const [openHour, openMinute] = openTime.split(':').map(Number);
                            const [closeHour, closeMinute] = closeTime.split(':').map(Number);
                            const nowMinutes = hour * 60 + minute;
                            const openMinutes = openHour * 60 + openMinute;
                            const closeMinutes = closeHour * 60 + closeMinute;
                            if (nowMinutes >= openMinutes && nowMinutes <= closeMinutes) return true;
                        }
                    }
                }
                return false;
            } catch (error) {
                console.error(`Error evaluating opening hours: ${error.message}`);
                return Math.random() < 0.8;
            }
        }
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        function generateHours() {
            const patterns = ['24 Hours', '06:00-22:00', '05:30-23:00', '07:00-21:00', 'Mo-Fr 06:00-22:00; Sa-Su 07:00-21:00'];
            return patterns[Math.floor(Math.random() * patterns.length)];
        }
        async function searchStations(searchQuery = null, radiusMeters = null) {
            showLoading(true);
            try {
                let searchLocation;
                if (searchQuery && searchQuery.trim()) {
                    searchLocation = await geocodeAddress(searchQuery);
                } else if (userLocation) {
                    searchLocation = userLocation;
                } else {
                    throw new Error('Please enter a location or enable location services');
                }
                const radius = radiusMeters || parseInt(document.getElementById('radius-select').value);
                allStations = await searchRealStations(searchLocation.lat, searchLocation.lng, radius, searchLocation.country_code || 'XX');
                map.setView([searchLocation.lat, searchLocation.lng], 13);
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.marker([searchLocation.lat, searchLocation.lng], {
                    icon: L.divIcon({
                        html: '<div style="background:#22c55e;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.4);"></div>',
                        iconSize: [20, 20],
                        className: 'user-location-marker'
                    })
                }).addTo(map).bindPopup(`<strong>Your Location</strong><br>${searchLocation.display_name || 'Current Position'}`);
                userLocation = searchLocation;
                applyFilter();
            } catch (error) {
                console.error(`Search error: ${error.message}`);
                updateApiStatus(error.message, 'error');
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }
        function showLoading(show) {
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.style.display = show ? 'flex' : 'grid';
            resultsContainer.innerHTML = show ? '<div class="loading" id="loading-state"><div class="spinner"></div>Searching...</div>' : resultsContainer.innerHTML;
        }
        function showError(message) {
            document.getElementById('results-container').innerHTML = `
                <div class="no-results">
                    <h3>No Stations Found</h3>
                    <p>${message}</p>
                    <p>Try increasing the search radius, searching a different location, or checking your internet connection.</p>
                    <button class="btn" onclick="tryAgain()" style="margin-top:1rem;" aria-label="Try a different location">Try Again</button>
                </div>`;
        }
        function tryAgain() {
            document.getElementById('location-input').value = '';
            document.getElementById('location-input').focus();
            updateApiStatus('Ready for a new search', 'default');
        }
        function applyFilter() {
            let filteredStations = [...allStations];
            switch (currentFilter) {
                case 'fuel': filteredStations = allStations.filter(s => s.type === 'fuel'); break;
                case 'ev': filteredStations = allStations.filter(s => s.type === 'ev'); break;
                case 'open': filteredStations = allStations.filter(s => s.isOpen); break;
            }
            displayResults(filteredStations);
            updateMapMarkers(filteredStations);
            updateApiStatus(`Showing ${filteredStations.length} ${currentFilter === 'all' ? 'stations' : currentFilter === 'ev' ? 'EV charging points' : 'fuel stations'}`, 'success');
        }
        function displayResults(stations) {
            const container = document.getElementById('results-container');
            if (stations.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <h3>No stations found</h3>
                        <p>Try increasing the search radius or searching in a different area.</p>
                        <button class="btn" onclick="tryAgain()" style="margin-top:1rem;" aria-label="Try a different location">Try Different Location</button>
                    </div>`;
                return;
            }
            container.innerHTML = stations.map(station => `
                <div class="station-card" data-id="${station.id}">
                    <div class="station-header">
                        <div>
                            <h3 class="station-name">${station.name}</h3>
                            <div class="station-distance">${(station.distance / 1000).toFixed(1)} km away • ${station.priceRange || 'Price unavailable'}</div>
                        </div>
                        <div class="station-status">
                            <div class="status-dot ${station.isOpen ? '' : 'closed'}"></div>
                            <span>${station.isOpen ? 'Open' : 'Closed'}</span>
                        </div>
                    </div>
                    <div class="station-rating">
                        <div class="rating-stars">${'★'.repeat(Math.floor(station.rating))}${'☆'.repeat(5-Math.floor(station.rating))}</div>
                        <div class="rating-number">${station.rating} (${station.reviewCount.toLocaleString()})</div>
                    </div>
                    <div class="station-address">${station.address}</div>
                    <div class="station-services">
                        ${station.services.map(service => `<span class="service-tag ${station.type}">${service}</span>`).join('')}
                    </div>
                    <div class="station-amenities">
                        ${station.amenities.map(a => `<span title="${a}">${amenityIcons[a] || '❓'}</span>`).join('')}
                    </div>
                    <div style="color:#888;font-size:.8rem;margin-bottom:1rem">${station.hours}</div>
                    <div class="station-actions">
                        <button class="action-btn primary" onclick="getDirections(${station.lat}, ${station.lng}, '${station.name.replace(/'/g, "\\'")}')" aria-label="Get directions to ${station.name}">Directions</button>
                        ${station.phone ? `<button class="action-btn" onclick="callStation('${station.phone}')" aria-label="Call ${station.name}">Call</button>` : ''}
                        ${station.website ? `<button class="action-btn" onclick="window.open('${station.website}', '_blank')" aria-label="Visit ${station.name} website">Website</button>` : ''}
                    </div>
                </div>
            `).join('');
        }
        function updateMapMarkers(stations) {
            currentMarkers.forEach(marker => map.removeLayer(marker));
            currentMarkers = [];
            stations.forEach(station => {
                const iconColor = station.type === 'ev' ? '#0ea5e9' : '#dc2626';
                const iconSymbol = station.type === 'ev' ? '⚡' : '⛽';
                const icon = L.divIcon({
                    html: `<div style="background:${iconColor};width:26px;height:26px;border-radius:50%;border:3px solid white;display:flex;align-items:center;justify-content:center;font-size:14px;color:white;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.3);cursor:pointer">${iconSymbol}</div>`,
                    iconSize: [26, 26],
                    className: 'custom-station-icon'
                });
                const marker = L.marker([station.lat, station.lng], { icon })
                    .addTo(map)
                    .bindPopup(`
                        <div style="color:#333;font-family:Inter,sans-serif;min-width:280px;max-width:320px">
                            <h3 style="margin:0 0 10px 0;color:#1a1a1a;font-size:18px;font-weight:600">${station.name}</h3>
                            <p style="margin:0 0 8px 0;font-size:14px;color:#666">${station.address}</p>
                            <div style="display:flex;justify-content:space-between;margin-bottom:10px">
                                <span style="font-size:13px;color:${station.isOpen ? '#22c55e' : '#ef4444'};font-weight:500">
                                    ${station.isOpen ? '✓ Open' : '✗ Closed'} • ${(station.distance / 1000).toFixed(1)} km
                                </span>
                                <span style="font-size:12px;color:#888;font-weight:500">${station.priceRange || 'Price unavailable'}</span>
                            </div>
                            <p style="margin:0 0 8px 0;font-size:12px;color:#888">${station.services.join(', ')}</p>
                            <div style="display:flex;gap:.5rem;font-size:14px;color:#666;margin:0 0 8px 0">${station.amenities.map(a => `<span title="${a}">${amenityIcons[a] || '❓'}</span>`).join('')}</div>
                            <p style="margin:0 0 8px 0;font-size:12px;color:#666">${station.hours}</p>
                            ${station.phone ? `<p style="margin:0;font-size:12px;color:#666">${station.phone}</p>` : ''}
                            ${station.website ? `<p style="margin:0;font-size:12px;color:#666"><a href="${station.website}" target="_blank">Website</a></p>` : ''}
                        </div>
                    `);
                currentMarkers.push(marker);
            });
        }
        function getDirections(lat, lng, name) {
            if (!userLocation) {
                updateApiStatus('Please set your location first', 'error');
                return;
            }
            if (routingControl) map.removeControl(routingControl);
            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(userLocation.lat, userLocation.lng),
                    L.latLng(lat, lng)
                ],
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1',
                    profile: 'driving'
                }),
                lineOptions: { styles: [{ color: '#3b82f6', weight: 5 }], addWaypoints: false },
                createMarker: () => null,
                show: true,
                collapsible: true,
                showAlternatives: true,
                fitSelectedRoutes: true
            }).addTo(map);
            updateApiStatus(`Directions to ${name} loaded`, 'success');
        }
        function callStation(phone) {
            window.location.href = `tel:${phone}`;
        }
        function openAffiliate(affiliate) {
            document.getElementById(`${affiliate}-popup`).style.display = 'flex';
        }
        function openAffiliatePopup(affiliate) {
            window.open(affiliateLinks[affiliate], '_blank', 'noopener,noreferrer');
            closePopup(`${affiliate}-popup`);
        }
        function closePopup(popupId) {
            document.getElementById(popupId).style.display = 'none';
        }
        async function autoDetectLocation() {
            if (window.location.protocol !== 'https:') {
                updateApiStatus('Please use HTTPS to enable location services', 'error');
                showError('This app requires HTTPS for location services. Please host on a secure server.');
                return;
            }
            showLoading(true);
            try {
                updateApiStatus('Requesting your location...', 'default');
                userLocation = await getUserLocation(3, 20000);
                updateApiStatus(`Location found (±${Math.round(userLocation.accuracy)}m, ${userLocation.country_code})`, 'success');
                // Removed automatic search to avoid slowness; user can click "Near Me"
            } catch (error) {
                console.error(`Auto-detect error: ${error.message}`);
                updateApiStatus('Location unavailable, please search manually', 'error');
                showError('Could not access location. Please search for a city or address.');
                document.getElementById('location-input').focus();
            } finally {
                showLoading(false);
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            document.getElementById('search-btn').addEventListener('click', () => {
                const query = document.getElementById('location-input').value.trim();
                if (query) searchStations(query);
                else updateApiStatus('Please enter a valid location to search', 'error');
            });
            document.getElementById('location-input').addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    const query = document.getElementById('location-input').value.trim();
                    if (query) searchStations(query);
                }
            });
            document.getElementById('near-me-btn').addEventListener('click', async () => {
                showLoading(true);
                try {
                    if (!userLocation) {
                        userLocation = await getUserLocation(3, 20000);
                    }
                    await searchStations(null, parseInt(document.getElementById('radius-select').value));
                } catch (error) {
                    console.error(`Near Me error: ${error.message}`);
                    updateApiStatus(error.message, 'error');
                    showError(error.message);
                } finally {
                    showLoading(false);
                }
            });
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.type;
                    applyFilter();
                });
                btn.addEventListener('keypress', e => {
                    if (e.key === 'Enter' || e.key === ' ') btn.click();
                });
            });
            autoDetectLocation();
        });
    </script>
</body>
</html>
