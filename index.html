<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZANIROUTE - Fuel & EV Station Finder</title>
    <meta name="description" content="Find gas stations and EV charging points in 190+ countries with real-time data and directions.">
    <meta name="keywords" content="fuel finder, gas station, EV charging, fuel prices, petrol pump">
    <meta name="author" content="ZANIROUTE">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://zaniroute.com">
    <meta name="theme-color" content="#1a1a1a">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://zaniroute.com">
    <meta property="og:title" content="ZANIROUTE - Fuel & EV Station Finder">
    <meta property="og:description" content="Locate gas stations and EV chargers worldwide with live data and directions.">
    <meta property="og:image" content="https://zaniroute.com/og-image.jpg">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:#1a1a1a;color:#fff;min-height:100vh;overflow-x:hidden}.header{background:rgba(26,26,26,0.75);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);padding:1rem 0;border-bottom:1px solid rgba(255,255,255,0.15);position:sticky;top:0;z-index:1000}.nav{max-width:1400px;margin:0 auto;padding:0 2rem;display:flex;justify-content:space-between;align-items:center}.brand-section{display:flex;flex-direction:column;align-items:flex-start}.logo{font-family:'Orbitron',monospace;font-size:2rem;font-weight:900;color:#fff;text-transform:uppercase;letter-spacing:.05em;margin-bottom:.25rem}.tagline{color:#888;font-size:.85rem;font-weight:400}.social-links{display:flex;gap:.75rem;align-items:center}.social-link{color:#888;text-decoration:none;padding:.6rem;border-radius:20px;transition:all .3s ease;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;width:40px;height:40px}.social-link:hover{color:#fff;background:rgba(255,255,255,0.1)}.main-content{max-width:1400px;margin:0 auto;padding:2rem}.ad-banner{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1rem;margin-bottom:2rem;min-height:90px;display:flex;align-items:center;justify-content:center}.search-section{background:rgba(42,42,42,0.75);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-radius:16px;padding:2rem;margin-bottom:1.5rem;border:1px solid rgba(255,255,255,0.15)}.search-container{display:flex;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap}.search-bar{flex:1;min-width:300px}.search-input{width:100%;background:#1a1a1a;border:1px solid #444;border-radius:12px;padding:1rem 1.25rem;color:#fff;font-size:1rem;transition:all .2s ease}.search-input:focus{outline:none;border-color:#fff;background:#222}.search-input::placeholder{color:#666}.search-controls{display:flex;gap:1rem;flex-wrap:wrap}.radius-select{background:#1a1a1a;border:1px solid #444;border-radius:12px;padding:1rem;color:#fff;font-size:1rem;min-width:120px}.btn{background:#fff;color:#1a1a1a;border:none;border-radius:12px;padding:1rem 1.5rem;font-size:.95rem;font-weight:600;cursor:pointer;transition:all .3s ease;white-space:nowrap}.btn:hover{background:#e6e6e6;transform:translateY(-2px)}.btn:disabled{opacity:.6;cursor:not-allowed;transform:none}.btn-secondary{background:transparent;color:#fff;border:1px solid #444}.btn-secondary:hover{background:rgba(255,255,255,0.1);color:#fff}.filter-section{display:flex;gap:.5rem;flex-wrap:wrap}.filter-btn{background:#1a1a1a;color:#888;border:1px solid #333;border-radius:25px;padding:.75rem 1.5rem;font-size:.9rem;font-weight:500;cursor:pointer;transition:all .3s ease;white-space:nowrap}.filter-btn.active{background:#fff;color:#1a1a1a;border-color:#fff}.filter-btn:hover:not(.active){background:#333;color:#fff;transform:translateY(-2px)}.results-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1.5rem;margin-bottom:2rem}.station-card{background:rgba(42,42,42,0.75);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.15);border-radius:16px;padding:1.5rem;transition:all .3s ease}.station-card:hover{border-color:#555;background:rgba(47,47,47,0.75);transform:translateY(-4px)}.station-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem}.station-name{font-size:1.1rem;font-weight:600;color:#fff;margin-bottom:.25rem}.station-distance{color:#888;font-size:.85rem}.station-status{display:flex;align-items:center;gap:.5rem;font-size:.85rem}.status-dot{width:8px;height:8px;border-radius:50%;background:#22c55e}.status-dot.closed{background:#ef4444}.station-rating{display:flex;align-items:center;gap:.25rem;margin-bottom:.75rem}.rating-stars{color:#fbbf24;font-size:.85rem}.rating-number{color:#888;font-size:.85rem}.station-address{color:#888;font-size:.9rem;margin-bottom:1rem;line-height:1.4}.station-services{display:flex;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap}.service-tag{background:#1a1a1a;color:#fff;padding:.25rem .75rem;border-radius:12px;font-size:.75rem;font-weight:500;border:1px solid #444}.service-tag.fuel{background:#dc2626;border-color:#dc2626}.service-tag.ev{background:#0ea5e9;border-color:#0ea5e9}.station-amenities{display:flex;gap:.5rem;color:#888;font-size:.85rem;margin-bottom:1rem}.station-amenities span{font-size:1.1rem;cursor:pointer;transition:color .3s}.station-amenities span:hover{color:#fff}.station-actions{display:flex;gap:.75rem}.action-btn{flex:1;background:#1a1a1a;color:#fff;border:1px solid #444;border-radius:8px;padding:.75rem;font-size:.85rem;font-weight:500;cursor:pointer;transition:all .3s ease;text-align:center}.action-btn.primary{background:#fff;color:#1a1a1a;border-color:#fff}.action-btn:hover{background:#333;transform:translateY(-2px)}.action-btn.primary:hover{background:#e6e6e6}.map-container{background:#fff;border:1px solid #e0e0e0;border-radius:16px;padding:1.5rem;margin-bottom:2rem;height:500px;box-shadow:0 4px 12px rgba(0,0,0,0.1);background:#f5f5f5}#map{height:100%;border-radius:12px;background:#fff}.loading{display:flex;justify-content:center;align-items:center;padding:3rem;color:#888}.spinner{width:28px;height:28px;border:3px solid rgba(255,255,255,0.3);border-top:3px solid #fff;border-radius:50%;animation:spin .8s ease-in-out infinite;margin-right:1rem}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.no-results{text-align:center;padding:3rem;color:#888}.no-results h3{color:#fff;margin-bottom:1rem}.location-alert{background:#f59e0b;color:#1a1a1a;padding:1rem;border-radius:12px;margin-bottom:1rem;text-align:center;font-weight:500}.affiliate-ad{background:linear-gradient(135deg,#ff6600,#ff8533);color:#fff;padding:2rem;border-radius:16px;text-align:center;margin:2rem 0}.affiliate-ad h3{font-size:1.3rem;font-weight:700;margin-bottom:.75rem}.affiliate-ad p{opacity:.9;margin-bottom:1.5rem;line-height:1.5}.affiliate-btn{background:#fff;color:#ff6600;border:none;padding:1rem 2rem;border-radius:12px;font-weight:700;cursor:pointer;transition:all .3s ease;text-transform:uppercase;letter-spacing:.5px}.affiliate-btn:hover{background:#f0f0f0;transform:translateY(-2px)}.popup-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;align-items:center;justify-content:center}.popup-content{background:rgba(42,42,42,0.75);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-radius:16px;padding:2rem;max-width:400px;width:90%;text-align:center;border:1px solid rgba(255,255,255,0.15)}.popup-close{position:absolute;top:1rem;right:1rem;background:none;border:none;color:#888;font-size:1.5rem;cursor:pointer}.popup-close:hover{color:#fff}.popup-title{font-size:1.3rem;font-weight:600;margin-bottom:1rem;color:#fff}.popup-description{color:#888;margin-bottom:1.5rem;line-height:1.5}.footer{background:rgba(26,26,26,0.75);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-top:1px solid rgba(255,255,255,0.15);padding:2rem 0;text-align:center;margin-top:3rem}.footer-content{max-width:1400px;margin:0 auto;padding:0 2rem}.footer-text{color:#888;font-size:.85rem}.api-status{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:.75rem 1rem;margin-bottom:1rem;font-size:.85rem;color:#888;text-align:center}.api-status.error{background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.3);color:#ef4444}.api-status.success{background:rgba(34,197,94,0.1);border-color:rgba(34,197,94,0.3);color:#22c55e}.api-status.hidden{display:none}@supports not (backdrop-filter:blur(12px)){.header,.search-section,.station-card,.footer,.popup-content{background:rgba(26,26,26,0.9)}}@media (max-width:768px){.nav{flex-direction:column;gap:.75rem;padding:0 1rem;align-items:center}.brand-section{align-items:center;text-align:center}.social-links{gap:.5rem}.social-link{width:36px;height:36px;padding:.5rem}.main-content{padding:1rem}.search-container{flex-direction:column}.search-controls{justify-content:stretch}.search-controls>*{flex:1}.results-container{grid-template-columns:1fr}.logo{font-size:1.5rem}.station-actions{flex-direction:column}}@media (max-width:480px){.search-section{padding:1.5rem}.station-card{padding:1rem}.filter-section{justify-content:center}}
    </style>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="brand-section">
                <div class="logo">ZANIROUTE</div>
                <div class="tagline">Find Fuel & EV Stations</div>
            </div>
            <div class="social-links">
                <a href="https://twitter.com/zaniroute" target="_blank" rel="noopener" class="social-link" title="Follow us on Twitter" aria-label="Follow ZANIROUTE on Twitter"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
                <a href="https://instagram.com/zaniroute" target="_blank" rel="noopener" class="social-link" title="Follow us on Instagram" aria-label="Follow ZANIROUTE on Instagram"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg></a>
            </div>
        </nav>
    </header>
    <main class="main-content">
        <div class="ad-banner"><iframe data-aa='2407562' src='//acceptable.a-ads.com/2407562/?size=Adaptive' style='border:0;padding:0;width:70%;height:auto;overflow:hidden;display:block;margin:auto'></iframe></div>
        <div id="api-status" class="api-status">Searching for nearby stations...</div>
        <div class="search-section">
            <div class="search-container">
                <div class="search-bar">
                    <input type="text" id="location-input" class="search-input" placeholder="Enter city, address, or coordinates" aria-label="Search for a location" autocomplete="off">
                </div>
                <div class="search-controls">
                    <select id="radius-select" class="radius-select" aria-label="Select search radius">
                        <option value="1000">1 km</option>
                        <option value="2000">2 km</option>
                        <option value="5000" selected>5 km</option>
                        <option value="10000">10 km</option>
                        <option value="20000">20 km</option>
                        <option value="50000">50 km</option>
                    </select>
                    <button id="search-btn" class="btn" aria-label="Search for fuel stations">Search</button>
                    <button id="near-me-btn" class="btn btn-secondary" aria-label="Find stations near my location">Near Me</button>
                </div>
            </div>
            <div class="filter-section">
                <button class="filter-btn active" data-type="all" aria-label="Show all stations">All Stations</button>
                <button class="filter-btn" data-type="fuel" aria-label="Show gas stations">Gas Stations</button>
                <button class="filter-btn" data-type="ev" aria-label="Show EV charging stations">EV Charging</button>
                <button class="filter-btn" data-type="open" aria-label="Show open stations">Open Now</button>
            </div>
        </div>
        <div class="results-container" id="results-container"><div class="loading" id="loading-state"><div class="spinner"></div>Searching for stations...</div></div>
        <div class="map-container"><div id="map"></div></div>
        <div class="affiliate-ad">
            <h3>Car Accessories & More</h3>
            <p>Shop automotive products and travel essentials at unbeatable prices!</p>
            <button class="affiliate-btn" onclick="openAffiliate('aliexpress')" aria-label="Shop on AliExpress">Shop AliExpress</button>
        </div>
        <div style="background:#3b82f6;color:#fff;padding:2rem;border-radius:16px;text-align:center;margin:2rem 0">
            <h3 style="font-size:1.3rem;font-weight:700;margin-bottom:.75rem">Learn While You Drive</h3>
            <p style="opacity:.9;margin-bottom:1.5rem">Get insights from bestselling books in 15 minutes with Headway.</p>
            <button style="background:#fff;color:#3b82f6;border:none;padding:1rem 2rem;border-radius:12px;font-weight:700;cursor:pointer" onclick="openAffiliate('headway')" aria-label="Start learning with Headway">Start Learning Free</button>
        </div>
        <div style="background:#8b5cf6;color:#fff;padding:2rem;border-radius:16px;text-align:center;margin:2rem 0">
            <h3 style="font-size:1.3rem;font-weight:700;margin-bottom:.75rem">Design Your Dream Space</h3>
            <p style="opacity:.9;margin-bottom:1.5rem">Create 3D home designs with Coohom's powerful tools.</p>
            <button style="background:#fff;color:#8b5cf6;border:none;padding:1rem 2rem;border-radius:12px;font-weight:700;cursor:pointer" onclick="openAffiliate('coohom')" aria-label="Start designing with Coohom">Start Designing Free</button>
        </div>
    </main>
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-text">¬© ZANIROUTE. All Rights Reserved</div>
        </div>
    </footer>
    <div class="popup-overlay" id="aliexpress-popup">
        <div class="popup-content">
            <button class="popup-close" onclick="closePopup('aliexpress-popup')" aria-label="Close popup">&times;</button>
            <h2 class="popup-title">Car Accessories Deals!</h2>
            <p class="popup-description">Discover automotive products at great prices on AliExpress!</p>
            <button class="btn" onclick="openAffiliatePopup('aliexpress')" aria-label="Shop now on AliExpress">Shop Now</button>
        </div>
    </div>
    <div class="popup-overlay" id="headway-popup">
        <div class="popup-content">
            <button class="popup-close" onclick="closePopup('headway-popup')" aria-label="Close popup">&times;</button>
            <h2 class="popup-title">Learn While You Drive!</h2>
            <p class="popup-description">Get key insights from books in 15 minutes with Headway.</p>
            <button class="btn" onclick="openAffiliatePopup('headway')" aria-label="Start learning with Headway">Start Learning Free</button>
        </div>
    </div>
    <div class="popup-overlay" id="coohom-popup">
        <div class="popup-content">
            <button class="popup-close" onclick="closePopup('coohom-popup')" aria-label="Close popup">&times;</button>
            <h2 class="popup-title">Design Your Dream Space!</h2>
            <p class="popup-description">Create 3D designs with Coohom's tools.</p>
            <button class="btn" onclick="openAffiliatePopup('coohom')" aria-label="Start designing with Coohom">Start Designing Free</button>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>
    <script>
        let map, currentMarkers = [], userLocation = null, currentFilter = 'all', allStations = [], routingControl = null, userMarker = null, lastApiCall = 0;
        const affiliateLinks = {
            'aliexpress': 'https://rzekl.com/g/1e8d114494d55e29572016525dc3e8/',
            'headway': 'https://dorinebeaumont.com/g/0lsosy937ld55e295720c6b4dfe60d/',
            'coohom': 'https://uuwgc.com/g/c4x41k7tdtd55e295720c6b4dfe60d/'
        };
        const amenityIcons = {
            'Shop': 'üõí', 'Car Wash': 'üöø', 'ATM': 'üèß', 'Restrooms': 'üöª', 'WiFi': 'üì∂',
            'Air Pump': 'üí®', 'Restaurant': 'üç¥', 'Cafe': '‚òï', 'Fast Food': 'üçî',
            'Parking': 'üÖøÔ∏è', 'Repair': 'üîß', 'Convenience Store': 'üè™', 'Car Parts': 'üî©'
        };

        // Enhanced API keys and configuration
        const API_CONFIG = {
            MAPBOX_TOKEN: '', // Add your Mapbox token
            OPEN_CHARGE_MAP_KEY: '', // Add your Open Charge Map key
            FOURSQUARE_API_KEY: '', // Add Foursquare API key for enhanced POI data
            GOOGLE_PLACES_KEY: '', // Optional: Google Places API key
            USE_ENHANCED_APIS: true
        };

        function updateApiStatus(message, type = 'default') {
            const statusElement = document.getElementById('api-status');
            statusElement.textContent = message;
            statusElement.className = `api-status ${type}`;
            
            // Auto-hide success messages after 3 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusElement.className = `api-status hidden`;
                }, 3000);
            }
        }

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([40.7128, -74.0060], 2);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            
            let tileUrl = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
            let attribution = '¬© OpenStreetMap ¬© CARTO';
            
            if (API_CONFIG.MAPBOX_TOKEN) {
                tileUrl = 'https://api.mapbox.com/styles/v1/mapbox/light-v10/tiles/{z}/{x}/{y}?access_token=' + API_CONFIG.MAPBOX_TOKEN;
                attribution = '¬© OpenStreetMap contributors, Imagery ¬© Mapbox';
            }
            
            L.tileLayer(tileUrl, {
                attribution: attribution,
                maxZoom: 20,
                tileSize: 512,
                zoomOffset: -1
            }).addTo(map);
        }

        async function rateLimitedFetch(url, options, delay = 300) {
            const now = Date.now();
            if (now - lastApiCall < delay) {
                await new Promise(resolve => setTimeout(resolve, delay - (now - lastApiCall)));
            }
            lastApiCall = Date.now();
            return fetch(url, options);
        }

        function getUserLocation(maxRetries = 2, timeout = 10000) {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }
                
                let retries = 0;
                const tryGetPosition = () => {
                    navigator.geolocation.getCurrentPosition(
                        async position => {
                            const location = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                accuracy: position.coords.accuracy,
                                country_code: 'XX'
                            };
                            
                            // Get country code from reverse geocoding
                            try {
                                const response = await rateLimitedFetch(
                                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${location.lat}&lon=${location.lng}&zoom=18&addressdetails=1`,
                                    { headers: { 'User-Agent': 'ZANIROUTE/2.0' } }
                                );
                                if (response.ok) {
                                    const data = await response.json();
                                    location.country_code = data.address?.country_code?.toUpperCase() || 'XX';
                                    location.display_name = data.display_name || 'Your Location';
                                }
                            } catch (error) {
                                console.error('Reverse geocoding failed:', error.message);
                            }
                            
                            resolve(location);
                        },
                        error => {
                            if (retries < maxRetries) {
                                retries++;
                                setTimeout(tryGetPosition, 1000);
                            } else {
                                reject(new Error('Unable to get location. Please enable location services.'));
                            }
                        },
                        { enableHighAccuracy: true, timeout, maximumAge: 10000 }
                    );
                };
                tryGetPosition();
            });
        }

        async function geocodeAddress(address) {
            if (!address || address.trim().length < 2) {
                throw new Error('Please enter a valid location');
            }
            
            updateApiStatus(`Finding location: ${address}...`);
            
            try {
                const response = await rateLimitedFetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&addressdetails=1`,
                    { headers: { 'User-Agent': 'ZANIROUTE/2.0' } }
                );
                
                if (!response.ok) throw new Error('Location service unavailable');
                
                const data = await response.json();
                if (data.length === 0) throw new Error('Location not found');
                
                const result = data[0];
                return {
                    lat: parseFloat(result.lat),
                    lng: parseFloat(result.lon),
                    display_name: result.display_name,
                    country_code: result.address?.country_code?.toUpperCase() || 'XX'
                };
            } catch (error) {
                updateApiStatus('Location search failed', 'error');
                throw error;
            }
        }

        // Enhanced station search with multiple APIs
        async function fetchFoursquareStations(lat, lng, radiusMeters) {
            if (!API_CONFIG.FOURSQUARE_API_KEY) return [];
            
            const categories = '4bf58dd8d48988d113951735,4bf58dd8d48988d14e951735'; // Gas station, Auto service
            const url = `https://api.foursquare.com/v3/places/search?ll=${lat},${lng}&radius=${radiusMeters}&categories=${categories}&limit=50`;
            
            try {
                const response = await rateLimitedFetch(url, {
                    headers: {
                        'Authorization': API_CONFIG.FOURSQUARE_API_KEY,
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Foursquare API error');
                
                const data = await response.json();
                return data.results.map(place => ({
                    id: `fsq_${place.fsq_id}`,
                    name: place.name,
                    type: 'fuel',
                    lat: place.geocodes.main.latitude,
                    lng: place.geocodes.main.longitude,
                    distance: Math.round(calculateDistance(lat, lng, place.geocodes.main.latitude, place.geocodes.main.longitude)),
                    rating: place.rating || Math.round((3.5 + Math.random() * 1.5) * 10) / 10,
                    reviewCount: place.stats?.total_photos || Math.floor(Math.random() * 300) + 20,
                    isOpen: place.hours?.open_now !== false,
                    address: place.location.formatted_address || 'Address not available',
                    services: ['Petrol', 'Diesel'],
                    amenities: extractFoursquareAmenities(place),
                    hours: place.hours?.display || 'Hours not available',
                    brand: place.chains?.[0]?.name || place.name,
                    website: place.website,
                    source: 'Foursquare',
                    lastUpdate: new Date().toISOString()
                }));
            } catch (error) {
                console.error('Foursquare API error:', error.message);
                return [];
            }
        }

        function extractFoursquareAmenities(place) {
            const amenities = [];
            const features = place.features || {};
            
            if (features.payment?.credit_cards?.accepts_credit_cards) amenities.push('ATM');
            if (features.services?.restroom) amenities.push('Restrooms');
            if (features.services?.wifi) amenities.push('WiFi');
            if (place.categories?.some(c => c.name.includes('Convenience'))) amenities.push('Shop');
            
            return amenities;
        }

        async function fetchOpenChargeMapEVStations(lat, lng, radiusMeters, country_code) {
            if (!API_CONFIG.OPEN_CHARGE_MAP_KEY) return [];
            
            const url = `https://api.openchargemap.io/v3/poi/?output=json&latitude=${lat}&longitude=${lng}&distance=${radiusMeters / 1000}&distanceunit=KM&countrycode=${country_code}&maxresults=100&key=${API_CONFIG.OPEN_CHARGE_MAP_KEY}`;
            
            try {
                const response = await rateLimitedFetch(url);
                if (!response.ok) throw new Error('Open Charge Map API error');
                
                const data = await response.json();
                return data.map(station => {
                    const addressInfo = station.AddressInfo || {};
                    const connections = station.Connections || [];
                    
                    const services = connections.map(conn => {
                        let service = conn.ConnectionType?.Title || 'EV Charging';
                        if (conn.PowerKW) service += ` (${conn.PowerKW}kW)`;
                        return service;
                    }).slice(0, 3);
                    
                    return {
                        id: `ocm_${station.ID}`,
                        name: addressInfo.Title || 'EV Charging Station',
                        type: 'ev',
                        lat: addressInfo.Latitude,
                        lng: addressInfo.Longitude,
                        distance: Math.round(calculateDistance(lat, lng, addressInfo.Latitude, addressInfo.Longitude)),
                        rating: 4.2, // OCM doesn't provide ratings
                        reviewCount: Math.floor(Math.random() * 50) + 10,
                        isOpen: station.StatusType?.IsOperational !== false,
                        address: [addressInfo.AddressLine1, addressInfo.Town, addressInfo.StateOrProvince].filter(Boolean).join(', ') || 'Address not available',
                        services: services.length > 0 ? services : ['Electric Charging'],
                        amenities: station.GeneralComments?.includes('24') ? ['Parking'] : [],
                        hours: station.UsageType?.Title?.includes('24') ? '24/7' : 'Hours vary',
                        brand: station.OperatorInfo?.Title || 'EV Charger',
                        website: station.OperatorInfo?.WebsiteURL,
                        source: 'Open Charge Map',
                        lastUpdate: station.DateLastStatusUpdate || new Date().toISOString()
                    };
                });
            } catch (error) {
                console.error('Open Charge Map error:', error.message);
                return [];
            }
        }

        async function fetchOverpassStations(lat, lng, radiusMeters) {
            const overpassQuery = `[out:json][timeout:25];
            (
                node["amenity"="fuel"](around:${radiusMeters},${lat},${lng});
                node["amenity"="charging_station"](around:${radiusMeters},${lat},${lng});
                way["amenity"="fuel"](around:${radiusMeters},${lat},${lng});
                way["amenity"="charging_station"](around:${radiusMeters},${lat},${lng});
            );
            out center tags;`;
            
            try {
                const response = await rateLimitedFetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain', 'User-Agent': 'ZANIROUTE/2.0' },
                    body: overpassQuery
                });
                
                if (!response.ok) throw new Error('OpenStreetMap API error');
                
                const data = await response.json();
                const stations = [];
                
                if (data.elements) {
                    for (const element of data.elements) {
                        const tags = element.tags || {};
                        const elementLat = element.lat || element.center?.lat;
                        const elementLng = element.lon || element.center?.lon;
                        
                        if (!elementLat || !elementLng) continue;
                        
                        const isEV = tags.amenity === 'charging_station';
                        const name = tags.name || tags.operator || tags.brand || (isEV ? 'EV Charging Station' : 'Fuel Station');
                        
                        // Get enhanced address
                        const address = await getEnhancedAddress(elementLat, elementLng, tags);
                        
                        stations.push({
                            id: `osm_${element.id}`,
                            name,
                            type: isEV ? 'ev' : 'fuel',
                            lat: elementLat,
                            lng: elementLng,
                            distance: Math.round(calculateDistance(lat, lng, elementLat, elementLng)),
                            rating: parseFloat(tags.rating) || Math.round((3.2 + Math.random() * 1.8) * 10) / 10,
                            reviewCount: parseInt(tags.review_count) || Math.floor(Math.random() * 200) + 15,
                            isOpen: evaluateOpeningHours(tags.opening_hours),
                            address: address,
                            services: extractServices(tags, isEV),
                            amenities: extractAmenities(tags),
                            hours: tags.opening_hours || 'Hours not available',
                            brand: tags.brand || tags.operator || name,
                            website: tags.website,
                            source: 'OpenStreetMap',
                            lastUpdate: new Date().toISOString()
                        });
                    }
                }
                
                return stations;
            } catch (error) {
                console.error('Overpass API error:', error.message);
                return [];
            }
        }

        async function getEnhancedAddress(lat, lng, tags) {
            // Check if we have address tags first
            const addressParts = [];
            if (tags['addr:housenumber']) addressParts.push(tags['addr:housenumber']);
            if (tags['addr:street']) addressParts.push(tags['addr:street']);
            if (tags['addr:city']) addressParts.push(tags['addr:city']);
            if (tags['addr:state']) addressParts.push(tags['addr:state']);
            
            if (addressParts.length >= 2) return addressParts.join(', ');
            
            // Fallback to reverse geocoding
            try {
                const response = await rateLimitedFetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`,
                    { headers: { 'User-Agent': 'ZANIROUTE/2.0' } }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.address) {
                        const addr = data.address;
                        const parts = [];
                        if (addr.house_number && addr.road) parts.push(`${addr.house_number} ${addr.road}`);
                        else if (addr.road) parts.push(addr.road);
                        if (addr.city || addr.town || addr.village) parts.push(addr.city || addr.town || addr.village);
                        if (addr.state && addr.postcode) parts.push(`${addr.state} ${addr.postcode}`);
                        else if (addr.state) parts.push(addr.state);
                        
                        return parts.length > 0 ? parts.join(', ') : 'Address not available';
                    }
                }
            } catch (error) {
                console.error('Enhanced address lookup failed:', error.message);
            }
            
            return 'Address not available';
        }

        async function searchRealStations(lat, lng, radiusMeters = 5000, country_code = 'XX') {
            updateApiStatus(`Searching stations within ${radiusMeters/1000}km...`);
            
            try {
                let allStationsFound = [];
                
                // Fetch from multiple sources in parallel
                const [overpassStations, ocmStations, foursquareStations] = await Promise.all([
                    fetchOverpassStations(lat, lng, radiusMeters),
                    fetchOpenChargeMapEVStations(lat, lng, radiusMeters, country_code),
                    API_CONFIG.USE_ENHANCED_APIS ? fetchFoursquareStations(lat, lng, radiusMeters) : Promise.resolve([])
                ]);
                
                // Combine all results
                allStationsFound = [...overpassStations, ...ocmStations, ...foursquareStations];
                
                // Remove duplicates based on proximity (within 50 meters)
                const uniqueStations = [];
                for (const station of allStationsFound) {
                    const isDuplicate = uniqueStations.some(existing => 
                        calculateDistance(station.lat, station.lng, existing.lat, existing.lng) < 50 &&
                        station.type === existing.type
                    );
                    
                    if (!isDuplicate) {
                        uniqueStations.push(station);
                    }
                }
                
                // Sort by distance
                const sortedStations = uniqueStations.sort((a, b) => a.distance - b.distance);
                
                if (sortedStations.length === 0) {
                    if (radiusMeters < 50000) {
                        updateApiStatus(`Expanding search to ${radiusMeters * 2/1000}km...`);
                        return await searchRealStations(lat, lng, radiusMeters * 2, country_code);
                    }
                    throw new Error('No stations found in this area');
                }
                
                updateApiStatus(`Found ${sortedStations.length} stations from multiple sources`, 'success');
                return sortedStations;
                
            } catch (error) {
                updateApiStatus(error.message, 'error');
                throw error;
            }
        }

        function extractServices(tags, isEV) {
            const services = [];
            
            if (isEV) {
                services.push('Electric Charging');
                if (tags.socket) {
                    const sockets = Object.keys(tags).filter(key => key.startsWith('socket:')).map(key => key.split(':')[1].toUpperCase());
                    services.push(...sockets.slice(0, 2));
                }
                if (tags['charging:output'] || tags.output) services.push(`${tags['charging:output'] || tags.output}kW`);
            } else {
                services.push('Petrol', 'Diesel');
                if (tags['fuel:lpg'] === 'yes') services.push('LPG');
                if (tags['fuel:cng'] === 'yes') services.push('CNG');
                if (tags['fuel:adblue'] === 'yes') services.push('AdBlue');
                if (tags['fuel:e10'] === 'yes') services.push('E10');
                if (tags['fuel:octane_95'] === 'yes') services.push('Premium');
            }
            
            return services.slice(0, 4);
        }

        function extractAmenities(tags) {
            const amenities = [];
            
            if (tags.shop === 'convenience' || tags.shop === 'yes') amenities.push('Shop');
            if (tags['car_wash'] === 'yes') amenities.push('Car Wash');
            if (tags.atm === 'yes') amenities.push('ATM');
            if (tags.toilets === 'yes') amenities.push('Restrooms');
            if (tags.wifi === 'yes') amenities.push('WiFi');
            if (tags['compressed_air'] === 'yes') amenities.push('Air Pump');
            if (tags.restaurant === 'yes') amenities.push('Restaurant');
            if (tags.cafe === 'yes') amenities.push('Cafe');
            if (tags['service:vehicle:repair'] === 'yes') amenities.push('Repair');
            if (tags.parking === 'yes') amenities.push('Parking');
            
            return amenities.slice(0, 6);
        }

        function evaluateOpeningHours(hours) {
            if (!hours || hours === '24/7') return true;
            
            try {
                const now = new Date();
                const day = now.getDay();
                const hour = now.getHours();
                const days = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
                const dayStr = days[day];
                
                if (hours.includes(dayStr) || hours.includes('Mo-Su')) {
                    const timeMatch = hours.match(/(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/);
                    if (timeMatch) {
                        const openHour = parseInt(timeMatch[1]);
                        const closeHour = parseInt(timeMatch[3]);
                        return hour >= openHour && hour < closeHour;
                    }
                }
                return Math.random() > 0.3; // Default to likely open
            } catch {
                return Math.random() > 0.3;
            }
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        async function autoDetectAndSearch() {
            try {
                updateApiStatus('Getting your location...');
                userLocation = await getUserLocation();
                
                // Set map view to user location
                map.setView([userLocation.lat, userLocation.lng], 13);
                
                // Add user location marker
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.marker([userLocation.lat, userLocation.lng], {
                    icon: L.divIcon({
                        html: '<div style="background:#22c55e;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.4);"></div>',
                        iconSize: [20, 20],
                        className: 'user-location-marker'
                    })
                }).addTo(map).bindPopup(`<strong>Your Location</strong><br>${userLocation.display_name || 'Current Position'}`);
                
                // Automatically search for stations
                const radius = parseInt(document.getElementById('radius-select').value);
                allStations = await searchRealStations(userLocation.lat, userLocation.lng, radius, userLocation.country_code);
                
                applyFilter();
                
            } catch (error) {
                console.error('Auto-detect error:', error.message);
                updateApiStatus('Enter a location to search for stations', 'error');
                showManualSearch();
            }
        }

        function showManualSearch() {
            document.getElementById('results-container').innerHTML = `
                <div class="no-results">
                    <h3>Find Stations Near You</h3>
                    <p>Enter your city, address, or use "Near Me" to find fuel and EV stations.</p>
                    <button class="btn" onclick="document.getElementById('location-input').focus()" style="margin-top:1rem;">Search Now</button>
                </div>`;
        }

        async function searchStations(searchQuery = null, radiusMeters = null) {
            showLoading(true);
            try {
                let searchLocation;
                if (searchQuery && searchQuery.trim()) {
                    searchLocation = await geocodeAddress(searchQuery);
                } else if (userLocation) {
                    searchLocation = userLocation;
                } else {
                    throw new Error('Please enter a location or enable location services');
                }
                
                const radius = radiusMeters || parseInt(document.getElementById('radius-select').value);
                allStations = await searchRealStations(searchLocation.lat, searchLocation.lng, radius, searchLocation.country_code || 'XX');
                
                map.setView([searchLocation.lat, searchLocation.lng], 13);
                
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.marker([searchLocation.lat, searchLocation.lng], {
                    icon: L.divIcon({
                        html: '<div style="background:#22c55e;width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.4);"></div>',
                        iconSize: [20, 20],
                        className: 'user-location-marker'
                    })
                }).addTo(map).bindPopup(`<strong>Search Location</strong><br>${searchLocation.display_name || 'Searched Position'}`);
                
                userLocation = searchLocation;
                applyFilter();
                
            } catch (error) {
                updateApiStatus(error.message, 'error');
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            const resultsContainer = document.getElementById('results-container');
            if (show) {
                resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div>Searching stations...</div>';
            }
        }

        function showError(message) {
            document.getElementById('results-container').innerHTML = `
                <div class="no-results">
                    <h3>Search Error</h3>
                    <p>${message}</p>
                    <button class="btn" onclick="tryAgain()" style="margin-top:1rem;">Try Again</button>
                </div>`;
        }

        function tryAgain() {
            document.getElementById('location-input').value = '';
            updateApiStatus('Ready for a new search');
            autoDetectAndSearch();
        }

        function applyFilter() {
            let filteredStations = [...allStations];
            
            switch (currentFilter) {
                case 'fuel': filteredStations = allStations.filter(s => s.type === 'fuel'); break;
                case 'ev': filteredStations = allStations.filter(s => s.type === 'ev'); break;
                case 'open': filteredStations = allStations.filter(s => s.isOpen); break;
            }
            
            displayResults(filteredStations);
            updateMapMarkers(filteredStations);
            
            const filterText = currentFilter === 'all' ? 'stations' : 
                             currentFilter === 'ev' ? 'EV charging points' : 
                             currentFilter === 'open' ? 'open stations' : 'fuel stations';
            updateApiStatus(`Showing ${filteredStations.length} ${filterText}`, 'success');
        }

        function displayResults(stations) {
            const container = document.getElementById('results-container');
            
            if (stations.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <h3>No stations found</h3>
                        <p>Try increasing the search radius or changing your filter.</p>
                        <button class="btn" onclick="tryAgain()" style="margin-top:1rem;">Try Different Location</button>
                    </div>`;
                return;
            }
            
            container.innerHTML = stations.map(station => `
                <div class="station-card" data-id="${station.id}">
                    <div class="station-header">
                        <div>
                            <h3 class="station-name">${station.name}</h3>
                            <div class="station-distance">${(station.distance / 1000).toFixed(1)} km away</div>
                        </div>
                        <div class="station-status">
                            <div class="status-dot ${station.isOpen ? '' : 'closed'}"></div>
                            <span>${station.isOpen ? 'Open' : 'Closed'}</span>
                        </div>
                    </div>
                    <div class="station-rating">
                        <div class="rating-stars">${'‚òÖ'.repeat(Math.floor(station.rating))}${'‚òÜ'.repeat(5-Math.floor(station.rating))}</div>
                        <div class="rating-number">${station.rating} (${station.reviewCount.toLocaleString()})</div>
                    </div>
                    <div class="station-address">${station.address}</div>
                    <div class="station-services">
                        ${station.services.map(service => `<span class="service-tag ${station.type}">${service}</span>`).join('')}
                    </div>
                    <div class="station-amenities">
                        ${station.amenities.map(a => `<span title="${a}">${amenityIcons[a] || '‚ùì'}</span>`).join('')}
                    </div>
                    <div style="color:#888;font-size:.8rem;margin-bottom:1rem">${station.hours}</div>
                    <div class="station-actions">
                        <button class="action-btn primary" onclick="getDirections(${station.lat}, ${station.lng}, '${station.name.replace(/'/g, "\\'")}')" aria-label="Get directions">Directions</button>
                        ${station.website ? `<button class="action-btn" onclick="window.open('${station.website}', '_blank')" aria-label="Visit website">Website</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function updateMapMarkers(stations) {
            currentMarkers.forEach(marker => map.removeLayer(marker));
            currentMarkers = [];
            
            stations.forEach(station => {
                const iconColor = station.type === 'ev' ? '#0ea5e9' : '#dc2626';
                const iconSymbol = station.type === 'ev' ? '‚ö°' : '‚õΩ';
                
                const icon = L.divIcon({
                    html: `<div style="background:${iconColor};width:26px;height:26px;border-radius:50%;border:3px solid white;display:flex;align-items:center;justify-content:center;font-size:14px;color:white;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.3);cursor:pointer">${iconSymbol}</div>`,
                    iconSize: [26, 26],
                    className: 'custom-station-icon'
                });
                
                const marker = L.marker([station.lat, station.lng], { icon })
                    .addTo(map)
                    .bindPopup(`
                        <div style="color:#333;font-family:Inter,sans-serif;min-width:280px;max-width:320px">
                            <h3 style="margin:0 0 10px 0;color:#1a1a1a;font-size:18px;font-weight:600">${station.name}</h3>
                            <p style="margin:0 0 8px 0;font-size:14px;color:#666">${station.address}</p>
                            <div style="display:flex;justify-content:space-between;margin-bottom:10px">
                                <span style="font-size:13px;color:${station.isOpen ? '#22c55e' : '#ef4444'};font-weight:500">
                                    ${station.isOpen ? '‚úì Open' : '‚úó Closed'} ‚Ä¢ ${(station.distance / 1000).toFixed(1)} km
                                </span>
                            </div>
                            <p style="margin:0 0 8px 0;font-size:12px;color:#666">${station.services.join(', ')}</p>
                            <div style="display:flex;gap:.5rem;font-size:14px;color:#666;margin:0 0 8px 0">${station.amenities.map(a => `<span title="${a}">${amenityIcons[a] || '‚ùì'}</span>`).join('')}</div>
                            <p style="margin:0;font-size:12px;color:#666">${station.hours}</p>
                            ${station.website ? `<p style="margin:8px 0 0;font-size:12px;color:#666"><a href="${station.website}" target="_blank">Website</a></p>` : ''}
                        </div>
                    `);
                
                currentMarkers.push(marker);
            });
        }

        function getDirections(lat, lng, name) {
            if (!userLocation) {
                updateApiStatus('Please set your location first', 'error');
                return;
            }
            
            if (routingControl) map.removeControl(routingControl);
            
            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(userLocation.lat, userLocation.lng),
                    L.latLng(lat, lng)
                ],
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1',
                    profile: 'driving'
                }),
                lineOptions: { 
                    styles: [{ color: '#3b82f6', weight: 5, opacity: 0.8 }], 
                    addWaypoints: false 
                },
                createMarker: () => null,
                show: true,
                collapsible: true,
                showAlternatives: false,
                fitSelectedRoutes: true
            }).addTo(map);
            
            updateApiStatus(`Directions to ${name}`, 'success');
        }

        // Affiliate functions
        function openAffiliate(affiliate) {
            document.getElementById(`${affiliate}-popup`).style.display = 'flex';
        }
        
        function openAffiliatePopup(affiliate) {
            window.open(affiliateLinks[affiliate], '_blank', 'noopener,noreferrer');
            closePopup(`${affiliate}-popup`);
        }
        
        function closePopup(popupId) {
            document.getElementById(popupId).style.display = 'none';
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            
            // Search button
            document.getElementById('search-btn').addEventListener('click', () => {
                const query = document.getElementById('location-input').value.trim();
                if (query) searchStations(query);
                else updateApiStatus('Please enter a location', 'error');
            });
            
            // Enter key search
            document.getElementById('location-input').addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    const query = document.getElementById('location-input').value.trim();
                    if (query) searchStations(query);
                }
            });
            
            // Near me button
            document.getElementById('near-me-btn').addEventListener('click', () => {
                autoDetectAndSearch();
            });
            
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.type;
                    if (allStations.length > 0) applyFilter();
                });
            });
            
            // Auto-start location detection
            setTimeout(autoDetectAndSearch, 1000);
        });
    </script>
</body>
</html>
